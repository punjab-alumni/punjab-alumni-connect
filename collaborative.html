<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Collaborative Spaces - Punjab Alumni Connect</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <style>
    /* add all previous CSS here */
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg,#101827,#183a6a 70%);
      color: #eafcff;
      margin: 0; padding: 0; min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background-color: #101927;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav {
      flex-grow: 1;
    }
    .nav-list {
      display: flex;
      gap: 15px;
      list-style: none;
      margin: 0; padding: 0;
      font-weight: 700;
      font-size: 1rem;
      color: #3bb4ff;
    }
    .nav-list a, .nav-list button {
      color: #3bb4ff;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 6px;
    }
    .nav-list a:hover, .nav-list button:hover, .nav-list a.active {
      background: #3bb4ff;
      color: #101827;
      font-weight: 700;
    }
    main {
      max-width: 1200px;
      margin: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      min-height: 90vh;
    }
    .topbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }
    .btn {
      background: #3bb4ff;
      color: #101827;
      padding: 12px 32px;
      border-radius: 23px;
      font-weight: 800;
      cursor: pointer;
      border: none;
      transition: background 0.3s ease;
      user-select: none;
    }
    .btn:hover {
      background: #176db8;
    }
    .rooms-list {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      min-height: 360px;
    }
    .room-card {
      background: #1e2c52;
      border-radius: 14px;
      flex: 1 1 260px;
      max-width: 280px;
      padding: 1rem 1rem 0.75rem;
      cursor: pointer;
      color: #a1c9ff;
      transition: box-shadow 0.3s ease, border-color 0.3s ease;
      border: 2px solid transparent;
      position: relative;
    }
    .room-card.selected, .room-card:hover {
      box-shadow: 0 0 25px #3bb4ffcc;
      border-color: #3bb4ff;
      color: #e5f0ff;
    }
    .room-card .delete-room {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      color: #f55c5c;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
      display: none;
    }
    .room-card.selected .delete-room {
      display: block;
    }
    .room-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #60d3ff;
      margin-bottom: 0.5rem;
    }
    .room-desc {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      min-height: 42px;
    }
    .room-members {
      font-size: 0.85rem;
      color: #7bbcfa;
      min-height: 18px;
      margin-bottom: 0.5rem;
    }
    .chat-container {
      flex-grow: 1;
      background: #224377;
      border-radius: 16px;
      padding: 25px;
      display: flex;
      flex-direction: column;
      max-height: 700px;
      width: 100%;
      max-width: 780px;
    }
    .chat-header {
      font-size: 1.4rem;
      font-weight: 700;
      color: #5ef1ff;
      margin-bottom: 18px;
    }
    .messages {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 10px;
      margin-bottom: 18px;
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: #5ef1ff transparent;
    }
    .messages::-webkit-scrollbar {
      width: 8px;
    }
    .messages::-webkit-scrollbar-track {
      background: transparent;
    }
    .messages::-webkit-scrollbar-thumb {
      background-color: #5ef1ff;
      border-radius: 10px;
    }
    .message {
      background: #165180;
      padding: 12px 20px;
      margin: 0.5rem 0;
      border-radius: 12px;
      color: #d9e8ff;
      position: relative;
    }
    .message.own {
      background: #64b7ff;
      color: #0c1a2d;
      align-self: flex-end;
    }
    .message-header {
      font-weight: 600;
      font-size: 0.85rem;
      color: #acdbff;
      margin-bottom: 5px;
    }
    .message-content {
      font-size: 1rem;
      white-space: pre-wrap;
    }
    .message-delete {
      position: absolute;
      top: 7px;
      right: 7px;
      background: transparent;
      border: none;
      color: #f55c5c;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      display: none;
    }
    .message.own .message-delete {
      display: block;
    }
    form.chat-form {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    form.chat-form input {
      flex-grow: 1;
      padding: 11px 15px;
      border-radius: 23px;
      border: none;
      background: #16355f;
      color: #abdefc;
      font-size: 1rem;
      outline: none;
    }
    form.chat-form button {
      padding: 11px 26px;
      border-radius: 26px;
      border: none;
      background: #5ef1ff;
      color: #0a1a2e;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    form.chat-form button:hover {
      background: #0a6c93;
      color: #fff;
    }
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.75);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: #224377;
      border-radius: 18px;
      padding: 24px;
      max-width: 420px;
      width: 100%;
      color: #b5d8ff;
      box-shadow: 0 0 14px #4daaffcc;
      user-select: none;
    }
    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 1.5rem;
      color: #5ef1ff;
    }
    .modal-content label {
      font-weight: 600;
      font-size: 1rem;
      display: block;
      margin: 10px 0 6px;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      border-radius: 10px;
      border: none;
      background: #1a2d54;
      color: #a7c3f3;
      padding: 12px 14px;
      font-size: 1rem;
      resize: vertical;
    }
    .modal-content textarea {
      min-height: 90px;
    }
    .modal-content button {
      width: 100%;
      margin-top: 20px;
      padding: 14px;
      font-weight: 700;
      font-size: 1.1rem;
      border-radius: 26px;
      border: none;
      background: #5ef1ff;
      color: #0a1a2e;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    .modal-content button:hover {
      background: #148aad;
      color: #fff;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.jpg" alt="Punjab Alumni Connect Logo" style="height: 60px; margin-right: 20px;">
    <nav>
      <ul class="nav-list">
        <li><a href="index.html">Home</a></li>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="alumni.html">Alumni</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="jobs.html">Jobs</a></li>
        <li><a href="mentorship.html">Mentorship</a></li>
        <li><a href="donations.html">Donations</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="collaborative.html" class="active">Collaborative Spaces</a></li>
        <li><button id="logout-btn">Logout</button></li>
      </ul>
    </nav>
  </header>
  <main>
    <div class="topbar">
      <h1>Collaborative Spaces</h1>
      <button class="btn" id="btn-create-room">+ Start New Room</button>
    </div>
    <div class="rooms-list" id="rooms-list"></div>
    <div class="chat-container" id="chat-container" style="display:none;">
      <div class="chat-header" id="chat-header">Room Title</div>
      <div class="messages" id="messages"></div>
      <form class="chat-form" id="chat-form" autocomplete="off">
        <input type="text" id="msg-input" placeholder="Type your message..." required />
        <button type="submit">Send</button>
      </form>
    </div>
  </main>

  <div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <h2 id="modal-title">Create New Room</h2>
      <form id="create-room-form" autocomplete="off">
        <label for="room-topic">Topic</label>
        <input type="text" id="room-topic" name="room-topic" required />
        <label for="room-desc">Description</label>
        <textarea id="room-desc" name="room-desc" required></textarea>
        <button type="submit">Create</button>
      </form>
    </div>
  </div>

  <script>
    // Login check (redirect if not logged in)
    const institution = sessionStorage.getItem('loggedInInstitution');
    const role = sessionStorage.getItem('loggedInRole');
    const email = sessionStorage.getItem('loggedInEmail');
    const name = sessionStorage.getItem('loggedInName') || "Anonymous";

    if (!institution || !role || !email) {
      window.location.href = 'login.html';
    }

    // Load saved rooms from localStorage or init with sample rooms
    let rooms = JSON.parse(localStorage.getItem('collabRooms')) || [
      {
        id: "room1",
        title: "AI and ML Projects",
        description: "Discuss AI & ML projects, ask for guidance.",
        creatorEmail: email,
        members: [{ name, role, university: institution }],
        messages: [{ id: 1, authorEmail: email, authorName: name, authorRole: role, authorUniversity: institution, text: "Welcome to the AI & ML room!", timestamp: new Date().toLocaleString() }]
      },
      {
        id: "room2",
        title: "Business Plan Brainstorm",
        description: "Pitch ideas and get feedback from alumni.",
        creatorEmail: "alumni1@otheruni.edu",
        members: [{ name: "Alumni1", role: "Alumni", university: "Other University" }],
        messages: []
      },
      {
        id: "room3",
        title: "Research Collaboration",
        description: "Work on joint research projects with peers.",
        creatorEmail: "alumni2@uni.edu",
        members: [{ name: "Alumni2", role: "Alumni", university: "Another University" }],
        messages: []
      },
      {
        id: "room4",
        title: "Career Advice",
        description: "Get career advice from industry experts.",
        creatorEmail: "mentor@puni.edu",
        members: [{ name: "Mentor", role: "Alumni", university: "Punjab University" }],
        messages: []
      },
    ];

    let currentRoomId = rooms[0]?.id;

    function saveRooms() {
      localStorage.setItem('collabRooms', JSON.stringify(rooms));
    }

    function renderRooms() {
      const container = document.getElementById('rooms-list');
      container.innerHTML = '';
      rooms.forEach(room => {
        const selected = room.id === currentRoomId ? "selected" : "";
        container.insertAdjacentHTML('beforeend', `
          <div class="room-card ${selected}" data-id="${room.id}">
            <div class="room-title">${room.title}</div>
            <div class="room-desc">${room.description}</div>
            <div class="room-members">
              Members: ${room.members.map(m => m.name + ' (' + m.role + ' - ' + m.university + ')').join(', ')}
            </div>
            ${room.creatorEmail === email ? '<button class="delete-room" title="Delete Room">×</button>' : ''}
          </div>
        `);
      });

      // Add room selection event
      document.querySelectorAll('.room-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.getAttribute('data-id');
          if (id !== currentRoomId) {
            currentRoomId = id;
            renderRooms();
            renderMessages();
          }
        });
      });

      // Add delete room event for user-owned rooms
      document.querySelectorAll('.delete-room').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation(); // prevent opening room
          const card = e.target.closest('.room-card');
          const id = card.getAttribute('data-id');
          const room = rooms.find(r => r.id === id);
          if (room && room.creatorEmail === email) {
            if (confirm('Are you sure you want to delete this room? This cannot be undone.')) {
              rooms = rooms.filter(r => r.id !== id);
              if (currentRoomId === id) {
                currentRoomId = rooms.length ? rooms[0].id : null;
              }
              saveRooms();
              renderRooms();
              renderMessages();
            }
          } else {
            alert('You do not have permission to delete this room.');
          }
        });
      });
    }

    function renderMessages() {
      const chatContainer = document.getElementById('chat-container');
      if (!currentRoomId) {
        chatContainer.style.display = 'none';
        return;
      }
      chatContainer.style.display = 'flex';

      const room = rooms.find(r => r.id === currentRoomId);
      if (!room) return;

      document.getElementById('chat-header').textContent = room.title;

      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
      room.messages.forEach(msg => {
        const ownClass = msg.authorEmail === email ? 'own' : '';
        const messageEl = document.createElement('div');
        messageEl.className = 'message ' + ownClass;
        messageEl.innerHTML = `
          <div class="message-header">${escapeHTML(msg.authorName)} (${escapeHTML(msg.authorRole)} - ${escapeHTML(msg.authorUniversity)}) | ${msg.timestamp}
            ${msg.authorEmail === email ? `<button class="message-delete" data-msgid="${msg.id}" title="Delete Message">×</button>` : ''}
          </div>
          <div class="message-content">${escapeHTML(msg.text)}</div>
        `;
        messagesContainer.appendChild(messageEl);
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Add delete event listeners for messages
      messagesContainer.querySelectorAll('.message-delete').forEach(btn => {
        btn.addEventListener('click', e => {
          const msgId = Number(e.target.getAttribute('data-msgid'));
          deleteMessage(currentRoomId, msgId);
        });
      });
    }

    function deleteMessage(roomId, msgId) {
      const room = rooms.find(r => r.id === roomId);
      if (!room) return;
      room.messages = room.messages.filter(m => m.id !== msgId);
      saveRooms();
      renderMessages();
    }

    // Escape possible HTML injection
    function escapeHTML(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.getElementById('chat-form').addEventListener('submit', e => {
      e.preventDefault();
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if (!text) return;

      const room = rooms.find(r => r.id === currentRoomId);
      if (!room) return;

      const msgId = room.messages.length ? Math.max(...room.messages.map(m => m.id)) + 1 : 1;
      const now = new Date();

      room.messages.push({
        id: msgId,
        authorEmail: email,
        authorName: name,
        authorRole: role,
        authorUniversity: institution,
        text: text,
        timestamp: now.toLocaleString()
      });

      saveRooms();
      renderMessages();

      input.value = '';
      input.focus();
    });

    // Create Room Modal Logic
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.id = 'modal-overlay';
    modalOverlay.innerHTML = `
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title">Create New Room</h2>
        <form id="create-room-form" autocomplete="off">
          <label for="room-topic">Topic</label>
          <input id="room-topic" type="text" required />
          <label for="room-desc">Description</label>
          <textarea id="room-desc" required></textarea>
          <button type="submit">Create</button>
        </form>
      </div>
    `;
    document.body.appendChild(modalOverlay);

    document.getElementById('btn-create-room').addEventListener('click', () => {
      modalOverlay.style.display = 'flex';
      document.getElementById('room-topic').value = '';
      document.getElementById('room-desc').value = '';
    });

    modalOverlay.addEventListener('click', e => {
      if (e.target === modalOverlay) modalOverlay.style.display = 'none';
    });

    document.getElementById('create-room-form').addEventListener('submit', e => {
      e.preventDefault();

      const topic = document.getElementById('room-topic').value.trim();
      const desc = document.getElementById('room-desc').value.trim();
      if (!topic || !desc) return;

      const newRoom = {
        id: "room-" + Date.now(),
        title: topic,
        description: desc,
        creatorEmail: email,
        members: [{ name, role, university: institution }],
        messages: []
      };

      rooms.push(newRoom);
      saveRooms();
      modalOverlay.style.display = 'none';

      currentRoomId = newRoom.id;
      renderRooms();
      renderMessages();
    });

    // Initial render
    renderRooms();
    renderMessages();

    // Logout button
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('collabRooms');
      sessionStorage.clear();
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>
